---
title: '[QNAP] TS-451PのNIC設定が変更できない'
date: 2018-12-30 14:41:16
categories:
  - QNAP
tags:
  - qnap
---

QNAPはネットワーク周りがちょっとイケてない部分が多い。昔はそうでもなかったけど、設定が「ネットワークと仮想スイッチ」に外出しされてからどうもトラブルが目に付くようになった。
今回またうまく動かない現象があったが、解決したのでメモっとく。

<!-- more -->

# いきさつ

QNAP TS-451Pのファームを１年ほど更新していなかったので、今日 `QTS 4.2.5` から `4.3.5` にアップデートを行った。

更新自体は正常に行われた（...と思われる）が、どうもネットワーク越しに接続できない。

- [Qfinder](https://www.qnap.com/ja-jp/utilities/essentials)で検索をしても見つからず。
- デフォルトのIP（169.254.100.100）に戻ったかと思い、IPを変えて接続しようとしても見つからず。

そこでもう一つのNICなら？と思い、TS-451Pの空いていたNICで接続したら、そちらは接続することができた。
元々使っていたNIC1（接続できないほう）は静的IPを振っていたが、NIC2のほうは「DHCP経由でIPを取得」設定になっていたので、DHCPサーバからIPが振られた形になっていた。

## 不可解な動き

接続できないNIC1は以下のような状態になっていた。

- 状態は`connected（接続済み）`
- アダプターリストのIPは`--`だが、詳細は`192.168.11.12`になっている。
- Qfinderからは`192.168.11.12`として見えている。
- 「ネットワークと仮想スイッチ」のサマリ画面でも`192.168.11.12`として見える。
- NICの設定から、設定を変更しようとしても反映されない。

特に一番最後が致命的で、以下の画面で「静的IPアドレスを使用する」から「DHCP経由でIPアドレス設定を自動取得する」に変更して「適用」ボタンを押しても、設定が変わらないのだ。

![設定を変更しても反映されない](/images/53-01.png)

## 迷子の仮想アダプタ

なんとなく仮想スイッチの画面を見たところ、仮想スイッチは無いのに仮想アダプタだけがあるように見えた。

ここでなんとなくピンと来た。（というか思い出した）

TS-451PのVirtualization Stationで仮想マシンを1台動かしていたが、その仮想マシンが外部接続するための仮想スイッチがファームアップデートで消えてしまったのではないだろうか。そしてその消えた仮想スイッチがNIC1を裏で掴んでいるので設定を変更できないのではないかと考えた。

# 修復する

NIC1に仮想スイッチを適用したらどうも直りそうだが、上記のようにおかしくなったNIC1はそのまま仮想スイッチに割り当てることができなかった。なので以下の手順で修復を試みる。

1. 正常に動作しているNIC2で仮想スイッチを作成し、仮想アダプタを割り当てる。
2. NIC1の表示が正常に戻る（設定もできるようになる）
3. NIC2の仮想スイッチを削除し、NIC1で仮想スイッチを作り直す。そして仮想アダプタを割り当て直す。

これで表示も以下のようになり、正常に接続できるようになった。

![正常に接続できるようになった](/images/53-02.png)

# さいごに

一応解決はしたが、再起動やファーム更新のタイミングでQNAPのネットワーク系はトラブルになりやすい。
次回は注意したい...と思いつつも、覚えてられるだろうかなぁ

## 環境

- TS-451P(QTS 4.3.5.0760)
- Network & Virtual Switch 2.0.0
